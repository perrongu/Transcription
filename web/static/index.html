<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="title">Transcription Locale</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card: rgba(30, 41, 59, 0.75);
      --accent: #22d3ee;
      --accent-2: #6366f1;
    }
    body { font-family: 'Space Grotesk', ui-sans-serif, system-ui; background: radial-gradient(circle at 20% 20%, rgba(99,102,241,.12), transparent 25%), radial-gradient(circle at 80% 10%, rgba(34,211,238,.12), transparent 20%), var(--bg); color: #e2e8f0; min-height: 100vh;}
    .card { background: var(--card); border: 1px solid rgba(148, 163, 184, 0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
    .glass { backdrop-filter: blur(10px); }
    .accent-gradient { background: linear-gradient(120deg, var(--accent), var(--accent-2)); }
    .lang-toggle button { transition: all 0.2s ease; }
    .lang-toggle .active { background: rgba(34,211,238,0.15); border-color: rgba(34,211,238,0.6); color: #e0f2fe; }
    .btn-disabled { opacity: 0.45; cursor: not-allowed; filter: saturate(0.2) brightness(0.9); pointer-events: none; }
    .progress-emphasis { box-shadow: 0 0 0 2px rgba(34,211,238,0.25), 0 25px 60px rgba(56,189,248,0.16); border-color: rgba(56,189,248,0.4); }
    .progress-bar-stripes { background-image: linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent); background-size: 28px 28px; animation: move 1.4s linear infinite; position: relative; }
    .progress-glow::after { content: ""; position: absolute; top: 0; left: -80px; width: 120px; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent); animation: sweep 1.3s ease-in-out infinite; }
    @keyframes move { 0% { background-position: 0 0; } 100% { background-position: 28px 0; } }
    @keyframes sweep { 0% { transform: translateX(0); opacity: 0.8; } 50% { opacity: 1; } 100% { transform: translateX(180%); opacity: 0.1; } }
  </style>
</head>
<body class="pb-16">
  <div class="max-w-6xl mx-auto px-4 pt-10">
    <header class="mb-10">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-sm uppercase tracking-[0.3em] text-sky-200/70" data-i18n="tagline">Local • Rapide • Confidentiel</p>
          <h1 class="text-4xl sm:text-5xl font-semibold mt-2" data-i18n="title">Transcription Locale</h1>
          <p class="text-slate-300 mt-2 max-w-2xl" data-i18n="subtitle">Dépose un fichier audio/vidéo, suis la progression en direct et récupère les sous-titres sans quitter ta machine.</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="lang-toggle flex bg-slate-900/60 rounded-lg border border-slate-700 overflow-hidden">
            <button id="lang-fr" class="px-3 py-2 text-sm border-r border-slate-700" aria-label="Passer en français">FR</button>
            <button id="lang-en" class="px-3 py-2 text-sm" aria-label="Switch to English">EN</button>
          </div>
          <div class="flex items-center gap-3 px-4 py-3 rounded-xl card glass">
            <div class="w-3 h-3 rounded-full bg-emerald-400 animate-pulse shadow-[0_0_0_6px_rgba(52,211,153,0.18)]"></div>
            <div>
              <p class="text-sm text-slate-300" data-i18n="serverLabel">Serveur local</p>
              <p class="font-semibold text-white">http://localhost:8765</p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">
      <section class="card glass p-6 rounded-2xl lg:col-span-3">
        <div id="dropzone" class="border-2 border-dashed border-slate-600 rounded-xl p-6 sm:p-8 text-center transition hover:border-sky-300 hover:bg-white/5 cursor-pointer" role="button" tabindex="0" aria-label="Zone de dépôt de fichier. Glisser-déposer ou cliquer pour sélectionner un fichier audio ou vidéo.">
          <input id="file-input" type="file" class="hidden" accept="audio/*,video/*" aria-label="Sélectionner un fichier audio ou vidéo" />
          <div id="drop-content" class="flex flex-col items-center gap-3 pointer-events-none">
            <div class="w-14 h-14 rounded-full bg-white/5 flex items-center justify-center accent-gradient text-slate-900 font-semibold shadow-lg" aria-hidden="true">＋</div>
            <p class="text-lg font-semibold text-white" data-i18n="dropTitle">Glisser-déposer un fichier</p>
            <p class="text-slate-400 text-sm" data-i18n="dropSubtitle">Ou clique pour parcourir. Formats audio/vidéo supportés (mp3, wav, mp4, mkv...)</p>
            <p id="selected-file" class="text-sky-200 font-medium" aria-live="polite"></p>
          </div>
          <div id="drop-selected" class="hidden">
            <div class="flex items-center justify-center gap-3 bg-emerald-500/10 border border-emerald-300/40 rounded-lg px-4 py-3 text-emerald-100">
              <span class="text-xl">✔</span>
              <div class="text-left">
                <p class="text-sm text-emerald-200" data-i18n="fileReady">Fichier prêt</p>
                <p id="selected-file-strong" class="font-semibold text-white truncate max-w-md"></p>
              </div>
              <button id="clear-file" class="ml-3 text-xs uppercase tracking-wide bg-emerald-400/20 hover:bg-emerald-400/30 border border-emerald-300/50 text-emerald-50 px-3 py-1 rounded-md transition" type="button" data-i18n="clearFile">Retirer</button>
            </div>
          </div>
        </div>

        <div id="options-panel" class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="card glass p-4 rounded-xl">
            <label class="block text-sm text-slate-300 mb-2" data-i18n="modelLabel">Modèle</label>
            <select id="model" class="w-full bg-slate-900/60 border border-slate-700 rounded-lg px-3 py-2 focus:outline-none focus:border-sky-300">
              <option value="tiny">tiny</option>
              <option value="base">base</option>
              <option value="small">small</option>
              <option value="medium">medium</option>
              <option value="large-v2">large-v2</option>
              <option value="large-v3" selected>large-v3</option>
            </select>
          </div>
          <div class="card glass p-4 rounded-xl">
            <label class="block text-sm text-slate-300 mb-2" data-i18n="languageLabel">Langue</label>
            <select id="language" class="w-full bg-slate-900/60 border border-slate-700 rounded-lg px-3 py-2 focus:outline-none focus:border-sky-300">
              <option value="fr" selected>Français</option>
              <option value="en">Anglais</option>
              <option value="auto">Auto</option>
            </select>
          </div>
          <div class="card glass p-4 rounded-xl">
            <label class="block text-sm text-slate-300 mb-2" data-i18n="computeLabel">Compute</label>
            <select id="compute" class="w-full bg-slate-900/60 border border-slate-700 rounded-lg px-3 py-2 focus:outline-none focus:border-sky-300">
              <option value="auto" selected>Auto</option>
              <option value="float16">float16</option>
              <option value="float32">float32</option>
              <option value="int8">int8</option>
              <option value="int8_float16">int8_float16</option>
            </select>
          </div>
          <div class="card glass p-4 rounded-xl">
            <label class="block text-sm text-slate-300 mb-2" data-i18n="beamLabel">Beam size</label>
            <input id="beam" type="number" min="1" max="10" value="5" class="w-full bg-slate-900/60 border border-slate-700 rounded-lg px-3 py-2 focus:outline-none focus:border-sky-300" />
          </div>
          <div class="card glass p-4 rounded-xl sm:col-span-2">
            <label class="block text-sm text-slate-300 mb-2" data-i18n="formatsLabel">Formats de sortie</label>
            <div class="flex flex-wrap gap-3">
              <label class="flex items-center gap-2 text-slate-200"><input type="checkbox" value="txt" class="format" checked>txt</label>
              <label class="flex items-center gap-2 text-slate-200"><input type="checkbox" value="srt" class="format" checked>srt</label>
              <label class="flex items-center gap-2 text-slate-200"><input type="checkbox" value="vtt" class="format" checked>vtt</label>
              <label class="flex items-center gap-2 text-slate-200"><input type="checkbox" value="json" class="format" checked>json</label>
            </div>
            <div class="flex flex-wrap gap-4 mt-3">
              <label class="flex items-center gap-2 text-slate-200">
                <input id="vad" type="checkbox" class="accent-sky-300" checked> <span data-i18n="vadLabel">VAD (Voice Activity Detection)</span>
              </label>
              <label class="flex items-center gap-2 text-slate-200">
                <span class="text-sm text-slate-400" data-i18n="sampleLabel">Échantillon (min)</span>
                <input id="sample" type="number" min="0" step="1" placeholder="optionnel" data-i18n-placeholder="samplePlaceholder" class="w-24 bg-slate-900/60 border border-slate-700 rounded-lg px-3 py-2 focus:outline-none focus:border-sky-300" />
              </label>
            </div>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 mt-6">
          <button id="start-btn" class="flex-1 accent-gradient text-slate-900 font-semibold py-3 rounded-xl shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/30 transition active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 focus:ring-offset-slate-800 btn-disabled" data-i18n="startButton" aria-label="Lancer la transcription du fichier sélectionné" disabled>Lancer la transcription</button>
          <button id="cancel-btn" class="px-4 py-3 rounded-xl border border-rose-500/50 text-rose-100 bg-rose-500/10 hover:bg-rose-500/20 transition font-semibold hidden" type="button" data-i18n="cancelButton">Annuler</button>
        </div>
      </section>

      <section class="lg:col-span-2 flex flex-col gap-4">
        <div id="progress-card" class="card glass rounded-2xl p-6 transition-all duration-300">
          <div class="flex items-center justify-between mb-3">
            <p class="text-sm uppercase tracking-[0.25em] text-slate-400" data-i18n="progressionTitle">Progression</p>
            <span id="status-pill" class="px-3 py-1 text-xs rounded-full bg-slate-700 text-slate-200" data-i18n="statusWaiting">En attente</span>
          </div>
          <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full accent-gradient w-0 transition-all duration-500"></div>
          </div>
          <p id="stage-text" class="mt-3 text-sm text-slate-300" data-i18n="stageIdle">En attente de lancement</p>
          <div class="mt-4 text-sm text-slate-300 space-y-1">
            <p><span class="text-slate-400" data-i18n="progressLabel">Avancement :</span> <span id="progress-text">0%</span></p>
            <p><span class="text-slate-400" data-i18n="lastSegmentLabel">Dernier segment :</span> <span id="last-text" class="text-slate-100">—</span></p>
            <p><span class="text-slate-400" data-i18n="segmentsLabel">Segments :</span> <span id="segments-count">0</span> | <span class="text-slate-400" data-i18n="wordsLabel">Mots :</span> <span id="words-count">0</span></p>
          </div>
        </div>

        <div class="card glass rounded-2xl p-6">
          <div class="flex items-center justify-between mb-3">
            <p class="text-sm uppercase tracking-[0.25em] text-slate-400" data-i18n="resultsTitle">Résultats</p>
            <span class="text-slate-400 text-sm" id="output-hint" data-state="waiting" data-i18n="outputHintWaiting">Téléchargement dès la fin</span>
          </div>
          <div id="downloads" class="grid grid-cols-2 gap-3">
            <a data-fmt="txt" class="download-btn disabled:pointer-events-none disabled:opacity-40 card glass border border-slate-700 px-3 py-2 rounded-lg text-center">TXT</a>
            <a data-fmt="srt" class="download-btn disabled:pointer-events-none disabled:opacity-40 card glass border border-slate-700 px-3 py-2 rounded-lg text-center">SRT</a>
            <a data-fmt="vtt" class="download-btn disabled:pointer-events-none disabled:opacity-40 card glass border border-slate-700 px-3 py-2 rounded-lg text-center">VTT</a>
            <a data-fmt="json" class="download-btn disabled:pointer-events-none disabled:opacity-40 card glass border border-slate-700 px-3 py-2 rounded-lg text-center">JSON</a>
          </div>
          <p id="error-msg" class="text-rose-300 text-sm mt-3 hidden"></p>
        </div>
      </section>
    </main>
  </div>

  <script>
    const i18n = {
      fr: {
        tagline: "Local • Rapide • Confidentiel",
        title: "Transcription Locale",
        subtitle: "Dépose un fichier audio/vidéo, suis la progression en direct et récupère les sous-titres sans quitter ta machine.",
        serverLabel: "Serveur local",
        dropTitle: "Glisser-déposer un fichier",
        dropSubtitle: "Ou clique pour parcourir. Formats audio/vidéo supportés (mp3, wav, mp4, mkv...)",
        modelLabel: "Modèle",
        languageLabel: "Langue",
        computeLabel: "Compute",
        beamLabel: "Beam size",
        formatsLabel: "Formats de sortie",
        vadLabel: "VAD (Voice Activity Detection)",
        sampleLabel: "Échantillon (min)",
        samplePlaceholder: "optionnel",
        startButton: "Lancer la transcription",
        progressionTitle: "Progression",
        resultsTitle: "Résultats",
        progressLabel: "Avancement :",
        lastSegmentLabel: "Dernier segment :",
        segmentsLabel: "Segments :",
        wordsLabel: "Mots :",
        statusWaiting: "En attente",
        statusUploading: "Upload...",
        statusActive: "En cours",
        statusDone: "Terminé",
        statusError: "Erreur",
        statusReconnecting: "Reconnexion...",
        statusStreamError: "Flux interrompu",
        outputHintWaiting: "Téléchargement dès la fin",
        outputHintReady: "Prêt à télécharger",
        alertNoFile: "Choisis un fichier à transcrire",
        alertNoFormat: "Sélectionne au moins un format de sortie",
        errorGeneric: "Une erreur est survenue.",
        errorUpload: "Une erreur est survenue lors de l'upload.",
        errorTimeout: "Timeout: le fichier est trop volumineux ou la connexion est trop lente.",
        fileTooLarge: "Fichier trop volumineux (max {max} GB)",
        formatUnsupported: "Format non supporté. Formats acceptés: {exts}",
        streamLost: "Connexion perdue. Vérifiez le statut du job.",
        fileReady: "Fichier prêt",
        clearFile: "Retirer",
        cancelButton: "Annuler",
        stageIdle: "En attente de lancement",
        stageRunning: "Tâche en cours...",
        stageCancelled: "Annulé",
        stage_prepare: "Préparation",
        stage_load_model: "Chargement du modèle...",
        stage_extract: "Extraction audio",
        stage_transcribe: "Transcription",
        stage_export: "Export des fichiers",
        stage_complete: "Terminé",
      },
      en: {
        tagline: "Local • Fast • Private",
        title: "Local Transcription",
        subtitle: "Drop an audio/video file, watch progress live, and download subtitles without leaving your machine.",
        serverLabel: "Local server",
        dropTitle: "Drag & drop a file",
        dropSubtitle: "Or click to browse. Supported audio/video (mp3, wav, mp4, mkv...)",
        modelLabel: "Model",
        languageLabel: "Language",
        computeLabel: "Compute",
        beamLabel: "Beam size",
        formatsLabel: "Output formats",
        vadLabel: "VAD (Voice Activity Detection)",
        sampleLabel: "Sample (min)",
        samplePlaceholder: "optional",
        startButton: "Start transcription",
        progressionTitle: "Progress",
        resultsTitle: "Results",
        progressLabel: "Progress:",
        lastSegmentLabel: "Last segment:",
        segmentsLabel: "Segments:",
        wordsLabel: "Words:",
        statusWaiting: "Waiting",
        statusUploading: "Uploading...",
        statusActive: "Processing",
        statusDone: "Done",
        statusError: "Error",
        statusReconnecting: "Reconnecting...",
        statusStreamError: "Stream interrupted",
        outputHintWaiting: "Downloads available when ready",
        outputHintReady: "Ready to download",
        alertNoFile: "Pick a file to transcribe",
        alertNoFormat: "Select at least one output format",
        errorGeneric: "An error occurred.",
        errorUpload: "An error occurred while uploading.",
        errorTimeout: "Timeout: the file is too large or the connection is too slow.",
        fileTooLarge: "File too large (max {max} GB)",
        formatUnsupported: "Unsupported format. Accepted: {exts}",
        streamLost: "Connection lost. Check the job status.",
        fileReady: "File ready",
        clearFile: "Remove",
        cancelButton: "Cancel",
        stageIdle: "Waiting to start",
        stageRunning: "Job running...",
        stageCancelled: "Cancelled",
        stage_prepare: "Preparing",
        stage_load_model: "Loading model...",
        stage_extract: "Extracting audio",
        stage_transcribe: "Transcribing",
        stage_export: "Exporting files",
        stage_complete: "Done",
      },
    };

    const dropzone = document.getElementById('dropzone');
    const dropContent = document.getElementById('drop-content');
    const dropSelected = document.getElementById('drop-selected');
    const fileInput = document.getElementById('file-input');
    const selectedFile = document.getElementById('selected-file');
    const selectedFileStrong = document.getElementById('selected-file-strong');
    const clearFileBtn = document.getElementById('clear-file');
    const optionsPanel = document.getElementById('options-panel');
    const startBtn = document.getElementById('start-btn');
    const statusPill = document.getElementById('status-pill');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const lastText = document.getElementById('last-text');
    const segmentsCount = document.getElementById('segments-count');
    const wordsCount = document.getElementById('words-count');
    const downloads = document.querySelectorAll('.download-btn');
    const errorMsg = document.getElementById('error-msg');
    const outputHint = document.getElementById('output-hint');
    const langFrBtn = document.getElementById('lang-fr');
    const langEnBtn = document.getElementById('lang-en');
    const stageText = document.getElementById('stage-text');
    const progressCard = document.getElementById('progress-card');
    const cancelBtn = document.getElementById('cancel-btn');

    let currentFile = null;
    let currentJobId = null;
    let evtSource = null;
    let enabledFormats = [];
    let currentLang = 'fr';
    let currentStatusKey = 'statusWaiting';
    let jobRunning = false;

    function updateStartButtonState() {
      const disabled = !currentFile || jobRunning;
      startBtn.disabled = disabled;
      startBtn.classList.toggle('btn-disabled', disabled);
    }

    function toggleInputs(visible) {
      if (visible) {
        dropzone.classList.remove('hidden');
        optionsPanel.classList.remove('hidden');
      } else {
        dropzone.classList.add('hidden');
        optionsPanel.classList.add('hidden');
      }
    }

    function tr(key) {
      return i18n[currentLang][key] || key;
    }

    function applyTranslations() {
      document.documentElement.lang = currentLang;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        const value = tr(key);
        if (value) el.textContent = value;
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        const value = tr(key);
        if (value) el.placeholder = value;
      });
      setStatus(currentStatusKey);
      outputHint.textContent = outputHint.dataset.state === 'ready' ? tr('outputHintReady') : tr('outputHintWaiting');
      langFrBtn.classList.toggle('active', currentLang === 'fr');
      langEnBtn.classList.toggle('active', currentLang === 'en');
      stageText.textContent = jobRunning ? tr('stageRunning') : tr('stageIdle');
    }

    function setStatus(key, tone = 'neutral') {
      currentStatusKey = key;
      statusPill.textContent = tr(key);
      const tones = {
        neutral: 'bg-slate-700 text-slate-200',
        active: 'bg-sky-500/20 text-sky-200 border border-sky-400/30',
        done: 'bg-emerald-500/20 text-emerald-200 border border-emerald-400/30',
        error: 'bg-rose-500/20 text-rose-200 border border-rose-400/30',
      };
      statusPill.className = `px-3 py-1 text-xs rounded-full ${tones[tone]}`;
      if (tone === 'active') {
        progressCard.classList.add('progress-emphasis');
        progressBar.classList.add('progress-bar-stripes', 'progress-glow');
      } else if (tone === 'done' || tone === 'error' || tone === 'neutral') {
        progressCard.classList.remove('progress-emphasis');
        progressBar.classList.remove('progress-bar-stripes', 'progress-glow');
      }
    }

    function resetUI() {
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      lastText.textContent = '—';
      segmentsCount.textContent = '0';
      wordsCount.textContent = '0';
      errorMsg.classList.add('hidden');
      errorMsg.textContent = '';
      downloads.forEach(btn => {
        btn.classList.add('disabled', 'opacity-40');
        btn.removeAttribute('href');
      });
      outputHint.textContent = tr('outputHintWaiting');
      outputHint.dataset.state = 'waiting';
      setStatus('statusWaiting', 'neutral');
      stageText.textContent = tr('stageIdle');
      jobRunning = false;
      cancelBtn.classList.add('hidden');
      cancelBtn.disabled = true;
      updateStartButtonState();
    }

    const MAX_FILE_SIZE = 2 * 1024 * 1024 * 1024; // 2 GB

    function attachFile(file) {
      if (!file) {
        currentFile = null;
        selectedFile.textContent = '';
        return;
      }

      // Validation de la taille
      if (file.size > MAX_FILE_SIZE) {
        const maxGb = (MAX_FILE_SIZE / (1024 ** 3)).toFixed(1);
        errorMsg.textContent = tr('fileTooLarge').replace('{max}', maxGb);
        errorMsg.classList.remove('hidden');
        currentFile = null;
        selectedFile.textContent = '';
        return;
      }

      // Validation de l'extension
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      const allowedExts = ['.mp3', '.wav', '.mp4', '.avi', '.mov', '.mkv', '.m4a', '.flac', '.ogg', '.webm'];
      if (!allowedExts.includes(ext)) {
        errorMsg.textContent = tr('formatUnsupported').replace('{exts}', allowedExts.join(', '));
        errorMsg.classList.remove('hidden');
        currentFile = null;
        selectedFile.textContent = '';
        return;
      }

      currentFile = file;
      selectedFile.textContent = file.name;
      selectedFileStrong.textContent = file.name;
      dropzone.classList.add('border-emerald-400', 'bg-emerald-500/5', 'shadow-lg', 'shadow-emerald-500/20');
      dropContent.classList.add('hidden');
      dropSelected.classList.remove('hidden');
      errorMsg.classList.add('hidden');
      updateStartButtonState();
    }

    function clearFile() {
      currentFile = null;
      fileInput.value = '';
      selectedFile.textContent = '';
      selectedFileStrong.textContent = '';
      dropzone.classList.remove('border-emerald-400', 'bg-emerald-500/5', 'shadow-lg', 'shadow-emerald-500/20');
      dropContent.classList.remove('hidden');
      dropSelected.classList.add('hidden');
      updateStartButtonState();
    }

    dropzone.addEventListener('click', (e) => {
      if (currentFile) return;
      if (e.target.closest('#clear-file')) return;
      fileInput.click();
    });
    dropzone.addEventListener('keydown', (e) => {
      if (currentFile) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });
    fileInput.addEventListener('change', (e) => attachFile(e.target.files[0]));

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-sky-300', 'bg-white/5');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-sky-300', 'bg-white/5'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-sky-300', 'bg-white/5');
      if (e.dataTransfer.files.length > 0) {
        attachFile(e.dataTransfer.files[0]);
      }
    });
    clearFileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      clearFile();
    });

    function collectFormats() {
      return Array.from(document.querySelectorAll('.format'))
        .filter(input => input.checked)
        .map(input => input.value);
    }

    function updateDownloads(jobId, formats) {
      downloads.forEach(btn => {
        if (formats.includes(btn.dataset.fmt)) {
          btn.classList.remove('disabled', 'opacity-40');
          btn.href = `/api/download/${jobId}/${btn.dataset.fmt}`;
        }
      });
      outputHint.textContent = tr('outputHintReady');
      outputHint.dataset.state = 'ready';
    }

    function handleProgress(payload) {
      const pct = Math.min(100, Math.round((payload.progress || 0) * 100));
      progressBar.style.width = `${pct}%`;
      progressText.textContent = `${pct}%`;
      if (payload.last_text) lastText.textContent = payload.last_text;
      if (payload.segments !== undefined) segmentsCount.textContent = payload.segments;
      if (payload.words !== undefined) wordsCount.textContent = payload.words;
    }

    function handleStage(payload) {
      const stage = payload.stage || 'prepare';
      const map = {
        prepare: 'stage_prepare',
        load_model: 'stage_load_model',
        extract: 'stage_extract',
        transcribe: 'stage_transcribe',
        export: 'stage_export',
        complete: 'stage_complete',
      };
      const key = map[stage] || 'statusActive';
      const tone = stage === 'complete' ? 'done' : 'active';
      setStatus(key, tone);
      stageText.textContent = tr(key === 'statusActive' ? 'stageRunning' : key);
    }

    function listenProgress(jobId, retryCount = 0) {
      // Nettoyer le timeout de retry précédent si existant
      if (window.currentRetryTimeout) {
        clearTimeout(window.currentRetryTimeout);
        window.currentRetryTimeout = null;
      }
      if (evtSource) {
        evtSource.close();
        evtSource = null;
      }
      const maxRetries = 3;
      evtSource = new EventSource(`/api/progress/${jobId}`);

      const onMessage = (event) => {
        try {
          const payload = JSON.parse(event.data);
          // Ignorer les heartbeats (juste pour maintenir la connexion)
          if (payload.type === 'heartbeat') {
            return;
          }
          if (payload.type === 'progress' || payload.type === 'done') handleProgress(payload);
          if (payload.type === 'stage') handleStage(payload);
          if (payload.type === 'complete') {
            handleProgress({ progress: 1, segments: payload.segments, words: payload.words, last_text: payload.last_text });
            setStatus('statusDone', 'done');
            if (evtSource) {
              evtSource.close();
              evtSource = null;
            }
            updateDownloads(jobId, payload.formats || enabledFormats);
            jobRunning = false;
            cancelBtn.classList.add('hidden');
            cancelBtn.disabled = true;
            stageText.textContent = tr('stage_complete');
            updateStartButtonState();
            toggleInputs(true);
          }
          if (payload.type === 'error') {
            setStatus('statusError', 'error');
            // Sanitizer basique pour éviter XSS (textContent échappe déjà, mais on limite la longueur)
            const errorText = (payload.message || tr('errorGeneric')).substring(0, 500);
            errorMsg.textContent = errorText;
            errorMsg.classList.remove('hidden');
            if (evtSource) {
              evtSource.close();
              evtSource = null;
            }
            jobRunning = false;
            cancelBtn.classList.add('hidden');
            cancelBtn.disabled = true;
            stageText.textContent = tr('stageIdle');
            updateStartButtonState();
            toggleInputs(true);
          }
          if (payload.type === 'cancelled') {
            setStatus('stageCancelled', 'neutral');
            errorMsg.textContent = '';
            errorMsg.classList.add('hidden');
            if (evtSource) {
              evtSource.close();
              evtSource = null;
            }
            jobRunning = false;
            cancelBtn.classList.add('hidden');
            cancelBtn.disabled = true;
            stageText.textContent = tr('stageCancelled');
            clearFile();
            updateStartButtonState();
            toggleInputs(true);
          }
        } catch (err) {
          console.warn('SSE payload invalide', err);
        }
      };

      evtSource.addEventListener('message', onMessage);
      ['stage', 'progress', 'complete', 'error', 'done'].forEach(evt => {
        evtSource.addEventListener(evt, onMessage);
      });

      evtSource.onerror = () => {
        if (evtSource) {
          evtSource.close();
          evtSource = null;
        }
        if (retryCount < maxRetries) {
          setStatus('statusReconnecting', 'active');
          const retryTimeout = setTimeout(() => {
            listenProgress(jobId, retryCount + 1);
          }, 1000 * (retryCount + 1));
          // Stocker le timeout pour pouvoir l'annuler si nécessaire
          if (window.currentRetryTimeout) clearTimeout(window.currentRetryTimeout);
          window.currentRetryTimeout = retryTimeout;
        } else {
          setStatus('statusStreamError', 'error');
          errorMsg.textContent = tr('streamLost');
          errorMsg.classList.remove('hidden');
        }
      };
    }

    async function startJob() {
      if (!currentFile) {
        errorMsg.textContent = tr('alertNoFile');
        errorMsg.classList.remove('hidden');
        return;
      }

      enabledFormats = collectFormats();
      if (enabledFormats.length === 0) {
        errorMsg.textContent = tr('alertNoFormat');
        errorMsg.classList.remove('hidden');
        return;
      }

      resetUI();
      startBtn.disabled = true;
      startBtn.classList.add('btn-disabled');
      setStatus('statusUploading', 'active');
      stageText.textContent = tr('stageRunning');
      jobRunning = true;
      cancelBtn.classList.remove('hidden');
      cancelBtn.disabled = false;
      updateStartButtonState();
      toggleInputs(false);

      const form = new FormData();
      form.append('file', currentFile);
      form.append('model', document.getElementById('model').value);
      form.append('language', document.getElementById('language').value);
      form.append('compute_type', document.getElementById('compute').value);
      form.append('beam_size', document.getElementById('beam').value);
      form.append('device', 'auto');
      form.append('vad_filter', document.getElementById('vad').checked ? 'true' : 'false');
      form.append('formats', enabledFormats.join(','));
      const sample = document.getElementById('sample').value;
      if (sample) {
        const sampleNum = parseFloat(sample);
        // Validation: doit être un nombre valide, positif et raisonnable (< 7 jours)
        if (!isNaN(sampleNum) && isFinite(sampleNum) && sampleNum > 0 && sampleNum <= 10080) {
          form.append('sample_minutes', sampleNum);
        } else if (sampleNum > 0) {
          // Avertir l'utilisateur mais ne pas bloquer
          console.warn('sample_minutes invalide, ignoré:', sampleNum);
        }
      }

      let timeoutId = null;
      try {
        const controller = new AbortController();
        timeoutId = setTimeout(() => controller.abort(), 300000); // 5 min timeout

        const res = await fetch('/api/transcribe', {
          method: 'POST',
          body: form,
          signal: controller.signal,
        });
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }

        if (!res.ok) {
          let msg = 'Impossible de lancer la transcription';
          try {
            const body = await res.json();
            msg = body.detail || body.message || msg;
          } catch (_) {
            const text = await res.text();
            if (text) msg = text;
          }
          throw new Error(msg);
        }
        const data = await res.json();
        currentJobId = data.job_id;
        setStatus('statusActive', 'active');
        listenProgress(currentJobId);
      } catch (err) {
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
        console.error(err);
        setStatus('statusError', 'error');
        if (err.name === 'AbortError') {
          errorMsg.textContent = tr('errorTimeout');
        } else {
          // Sanitizer basique pour éviter XSS
          const errorText = (err.message || tr('errorUpload')).substring(0, 500);
          errorMsg.textContent = errorText;
        }
        errorMsg.classList.remove('hidden');
        clearFile();
        toggleInputs(true);
        jobRunning = false;
        updateStartButtonState();
      }
    }

    function setLang(lang) {
      currentLang = lang;
      applyTranslations();
    }

    startBtn.addEventListener('click', startJob);
    langFrBtn.addEventListener('click', () => setLang('fr'));
    langEnBtn.addEventListener('click', () => setLang('en'));
    cancelBtn.addEventListener('click', async () => {
      if (!currentJobId) {
        clearFile();
        return;
      }
      cancelBtn.disabled = true;
      try {
        await fetch(`/api/cancel/${currentJobId}`, { method: 'POST' });
      } catch (err) {
        console.error('Cancel failed', err);
      } finally {
        setStatus('stageCancelled', 'neutral');
        stageText.textContent = tr('stageCancelled');
        jobRunning = false;
        clearFile();
        updateStartButtonState();
        toggleInputs(true);
      }
    });
    applyTranslations();
    resetUI();
  </script>
</body>
</html>
